# Noter v0.0.1 Implementation

## Global Instructions
- All dates must be in format d.m.YYYY HH.MM (without leading zeros for day/month)
- Maintain POSIX compliance
- Use 'uv' for package and runtime management
- Python version 3.12

## Overview
Note taking application with a Python core program that can execute shell scripts for search functionality via command-line flags.

## Environment Configuration
Environment variables are defined in `.env` file:
- `NOTES_DIR`: Directory where notes are stored (default: ./notes)
- `NOTES_EDITOR`: Text editor for opening files (examples: vim, micro, nvim)

## File Structure
Notes are organized as:
```
$NOTES_DIR/MONTH.YEAR/day.month.year.txt
```
Example: `./notes/8.2025/8.8.2025.txt`

## Core Program (noter.py)

### Dependencies
- python-dotenv: For loading .env file

### Task Configuration
- Reads task definitions from `tasks.json` (file is ignored in version control)
- Format: `[{"prefix": "PREFIX", "task": "Description"}]`
- Users can configure their own custom prefixes and task descriptions

### Main Functionality
1. **Task Display**: Lists all available tasks with zebra striping
   - Even rows: White text on black background
   - Odd rows: White text on dark gray background
   - Format: `PREFIX | TASK`
   - Shows "Usage: [PREFIX] [NOTE]" prompt

2. **Note Input**: Accepts input in format `PREFIX SPACE NOTE`
   - Validates prefix against tasks.json
   - Shows error for unknown prefixes

3. **Note Storage**: 
   - Format: `[TIMESTAMP] [TASK_NAME] Note content`
   - Timestamp format: `d.m.YYYY HH.MM`
   - Auto-creates directory structure

4. **Keyboard Handling**:
   - **Enter**: Saves note and continues program
   - **Ctrl+C**: Saves current note (if any) and exits program
   - **Ctrl+D**: Exits program without saving current input
   - **Duplicate Prevention**: Tracks last saved input to prevent duplicate saves when pressing Ctrl+C after Enter

## Command Line Flags

### -f (File Search)
- Executes `search-files.sh`
- Uses fzf to search filenames in `$NOTES_DIR`
- Opens selected file in `$NOTES_EDITOR`

### -s (Content Search)
- Executes `search-content.sh`
- Uses fzf to search text content within all `.txt` files
- Opens selected file in `$NOTES_EDITOR` positioned at the found line
- Uses `+line_number` parameter for editor positioning

## Shell Scripts

### search-files.sh
```bash
#!/bin/bash
# Load .env variables
# Find all .txt files and pipe to fzf
# Open selected file in $NOTES_EDITOR
```

### search-content.sh  
```bash
#!/bin/bash
# Load .env variables
# Use find + grep to search all .txt files for content and pipe to fzf
# Extract filename and line number from selection
# Open file at specific line: $NOTES_EDITOR +line_number filename
```

## Usage Examples

### Basic Note Taking
```bash
uv run noter.py
# Shows task list with zebra striping
# Enter: TODO Fix login bug
# Saves: [8.8.2025 19.15] [General tasks and reminders] Fix login bug
```

### File Search
```bash
uv run noter.py -f
# Interactive fzf file selector
# Opens selected file in configured editor
```

### Content Search
```bash
uv run noter.py -s
# Interactive fzf content search
# Opens file at exact line where content was found
```

## Technical Implementation

### Signal Handling
- Uses `signal.SIGINT` handler for Ctrl+C
- Accesses partial input via `readline.get_line_buffer()`
- Saves in-progress notes before termination
- Prevents duplicate saves by tracking `last_saved_input`

### Date/Time Handling
- Custom formatting without leading zeros
- Directory: `month.year` (e.g., "8.2025")
- Filename: `day.month.year.txt` (e.g., "8.8.2025.txt")
- Timestamp: `day.month.year hour.minute` (e.g., "8.8.2025 19.15")

### Error Handling
- Graceful handling of missing directories
- Validation of task prefixes
- Proper exit codes for shell scripts
- fzf cancellation handling

## Files Structure
```
noter/
├── .env                # Environment configuration
├── noter.py            # Main Python program
├── tasks.json          # Task definitions (ignored in git)
├── search-files.sh     # File search script
├── search-content.sh   # Content search script
├── pyproject.toml      # uv project configuration
├── README.md           # User documentation
├── versions/           # Version documentation
│   ├── v0.0.0.md       # Original specification
│   └── v0.0.1.md       # Current implementation
└── notes/              # Notes directory
    └── month.year/
        └── day.month.year.txt
```

## Bug Fixes in v0.0.1
- **Duplicate Note Prevention**: Fixed issue where pressing Ctrl+C after Enter would duplicate the previously saved note
- **Content Search Reliability**: Improved grep command using `find + grep` instead of `grep -r` for more reliable content searching
- **Line Positioning**: Added proper line positioning in content search using `+line_number` parameter
